<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudang Ceria - Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content { transition: all 0.3s ease-out; transform: scale(0.95); }
        .is-open { opacity: 1; pointer-events: auto; }
        .is-open .modal-content { transform: scale(1); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-3 rounded-xl">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Gudang Ceria</h1>
                        <p class="text-gray-600">Cekatan, Rapi, Indah, dan Aman</p>
                    </div>
                </div>
                <button onclick="exportToExcel()" class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white px-6 py-3 rounded-full font-semibold hover:from-emerald-700 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-lg flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Export Data</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-lg p-2 mb-8">
            <nav class="flex space-x-2">
                <button onclick="showTab('stock')" id="stockTab" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                    üì¶ Stok Terkini
                </button>
                <button onclick="showTab('incoming')" id="incomingTab" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                    üì• Barang Masuk
                </button>
                <button onclick="showTab('outgoing')" id="outgoingTab" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                    üì§ Barang Keluar
                </button>
                <button onclick="showTab('return')" id="returnTab" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                    ‚Ü©Ô∏è Pengembalian Barang
                </button>
            </nav>
        </div>

        <div id="stockContent" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 mb-8">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Ringkasan Stok Total</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="stockSummary">
                    <div class="p-4 bg-green-50 rounded-xl flex justify-between items-center">
                        <span class="text-gray-700">Total Masuk</span>
                        <span class="font-bold text-xl text-green-600" id="totalIncoming">0</span>
                    </div>
                    <div class="p-4 bg-red-50 rounded-xl flex justify-between items-center">
                        <span class="text-gray-700">Total Keluar</span>
                        <span class="font-bold text-xl text-red-600" id="totalOutgoing">0</span>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl flex justify-between items-center">
                        <span class="text-gray-700">Sisa Stok</span>
                        <span class="font-bold text-xl text-blue-600" id="remainingStock">0</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">Daftar Stok Barang</h3>
                    <p class="text-gray-600 mt-1">Klik nama barang untuk melihat detail akumulasi.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Nama Barang</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Kategori</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Total Stok</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="divide-y divide-gray-200">
                            <tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">Memuat data stok...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="incomingContent" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">Input Barang Masuk</h3>
                </div>
                <div class="p-6">
                    <form id="incomingForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Barang</label>
                            <input type="text" id="incomingItemName" name="name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
                            <select id="incomingCategory" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih kategori</option>
                                <option value="Aset">Aset</option>
                                <option value="Habis pakai">Habis pakai</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Jumlah</label>
                            <input type="number" id="incomingQuantity" name="quantity" min="1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Kondisi Barang</label>
                            <select id="incomingCondition" name="condition" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                <option value="Baik">Baik</option>
                                <option value="Rusak">Rusak</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ruang</label>
                            <input type="text" id="incomingRoom" name="room" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Kode Rak</label>
                            <input type="text" id="incomingRackCode" name="rackCode" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="col-span-full">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                            <textarea id="incomingDescription" name="description" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" rows="2" required></textarea>
                        </div>
                        <div class="col-span-full md:col-span-1">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Masuk</label>
                            <input type="date" id="incomingDate" name="date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="col-span-full md:col-span-1 flex items-end">
                            <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                                ‚ûï Simpan Barang Masuk
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="outgoingContent" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">Ambil Barang Keluar</h3>
                    <p class="text-gray-600 mt-1">Pilih barang dan jumlah yang akan diambil.</p>
                </div>
                <div class="p-6">
                    <form id="outgoingForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Barang</label>
                            <select id="outgoingItemSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih barang (Stok tersedia: 0)</option>
                            </select>
                        </div>
                        
                        <div id="batchSelectContainer" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Detail Batch (FIFO Disarankan)</label>
                            <select id="outgoingBatchSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih batch spesifik</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="font-semibold">Detail Batch:</span> <span id="batchDetailInfo">Pilih batch untuk melihat deskripsi lengkap.</span>
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Jumlah Barang Keluar</label>
                            <input type="number" id="outgoingQuantity" min="1" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Masukkan jumlah" required>
                            <p class="text-sm text-gray-500 mt-1">Stok tersedia di batch ini: <span id="availableBatchStock">0</span></p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pengguna</label>
                            <input type="text" id="outgoingUser" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Nama pengguna yang mengambil barang" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Keluar</label>
                            <input type="date" id="outgoingDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-red-700 hover:to-pink-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                            ‚ûñ Ambil Barang
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="returnContent" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900">Pengembalian Barang</h3>
                    <p class="text-gray-600 mt-1">Daftar Aset yang saat ini sedang dipinjam (Belum Dikembalikan).</p>
                </div>
                <div class="p-6">
                    <div id="borrowedItemsList" class="space-y-4">
                        <p class="text-center text-gray-500 py-4">Memuat data barang yang dipinjam...</p>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stockDetailModal" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-900">Detail Stok: <span id="stockDetailName" class="text-blue-600"></span></h3>
                <button onclick="closeModal('stockDetailModal')" class="text-gray-500 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="stockDetailContent" class="max-h-96 overflow-y-auto space-y-4">
                <p>Memuat...</p>
            </div>
        </div>
    </div>

    <div id="outgoingConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-900">Konfirmasi Pengambilan Barang</h3>
                <button onclick="closeModal('outgoingConfirmationModal')" class="text-gray-500 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="outgoingConfirmationContent" class="space-y-4">
                <p>Anda yakin ingin mengambil barang ini?</p>
                </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('outgoingConfirmationModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl font-semibold hover:bg-gray-400 mr-2">Batal</button>
                <button id="confirmOutgoingBtn" class="bg-red-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-red-700">Konfirmasi Ambil</button>
            </div>
        </div>
    </div>

    <div id="returnDetailModal" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-gray-900">Detail Pengembalian</h3>
                <button onclick="closeModal('returnDetailModal')" class="text-gray-500 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="returnDetailContent" class="space-y-4">
                </div>
        </div>
    </div>


    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center">
                <p class="text-lg font-semibold text-blue-300 mb-2">Gudang Ceria - Cekatan, Rapi, Indah, dan Aman</p>
                <p class="text-gray-400 text-sm">Inventory Management System</p>
            </div>
        </div>
    </footer>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ===========================================
    // *** KONFIGURASI SUPABASE ***
    // GANTI DENGAN KUNCI DAN URL SUPABASE ANDA
    // ===========================================
    const SUPABASE_URL = 'https://ixbujhmqvbmyihvocfmw.supabase.co'; // GANTI INI
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4YnVqaG1xdmJteWlodm9jZm13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMDg4MTMsImV4cCI6MjA3NjU4NDgxM30.Jja-9XyFfiOYKK9-E2rtosSm4Dp315PR0zTOmXFaFYw'; // GANTI INI
    const NOTIFICATION_EMAIL = 'admin@gudangceria.com'; // Contoh Email

    let supabase = null;
    try {
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error("Supabase URL atau key kosong.");
        }
    } catch (e) {
        console.error("Error creating Supabase client:", e);
    }

    if (!supabase) {
        console.error("Supabase client not initialized. Please check your keys and URL.");
        showMessage('‚ùå Koneksi database gagal. Cek konsol untuk detail.', 'error');
    }

    // Variabel global untuk cache data
    let incomingItems = []; 
    let outgoingItems = []; 
    let aggregatedStock = {}; 
    let borrowedItems = []; 

    // ===========================================
    // FUNGSI UTILITY & EXTERNAL STUBS
    // ===========================================

    function uploadFile(file, bucketName = 'inventory_photos') {
        if (!supabase) throw new Error("Supabase is not initialized.");
        if (!file) return null;

        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
        const filePath = `public/${fileName}`;

        // Simulasi upload
        console.log(`[STUB] Mengunggah file ${fileName} ke bucket ${bucketName}`);
        
        // Dapatkan URL publik (simulasi)
        const publicUrl = `https://${SUPABASE_URL.split('//')[1]}/storage/v1/object/public/${bucketName}/${filePath}`;
        
        return Promise.resolve(publicUrl);
    }

    function sendEmailNotification(subject, body) {
        console.log(`[EMAIL STUB] Mengirim ke ${NOTIFICATION_EMAIL}. Subjek: ${subject}. Isi: ${body.substring(0, 100)}...`);
    }
    
    function getItemMetadata(name, category) {
        const newestEntry = incomingItems.find(item =>
            item.name === name && item.category === category
        );

        if (!newestEntry) return null;

        return {
            rackCode: newestEntry.rackCode || 'N/A',
            condition: newestEntry.condition || 'N/A',
            description: newestEntry.description || 'N/A',
            room: newestEntry.room || 'N/A',
        };
    }
    
    function getAvailableBatches(name, category) {
        const key = `${name}|${category}`;
        if (!aggregatedStock[key]) return [];
        
        // Diurutkan berdasarkan tanggal terlama (FIFO)
        return aggregatedStock[key].incomingDetails
            .sort((a, b) => new Date(a.date) - new Date(b.date)) 
            .map(batch => ({
                id: batch.id,
                quantity: batch.quantity,
                date: batch.date,
                rackCode: batch.rackCode,
                condition: batch.condition,
                description: batch.description,
                room: batch.room,
            }));
    }


    // ===========================================
    // FUNGSI UTAMA CRUD DENGAN SUPABASE
    // ===========================================

    async function fetchData() {
        if (!supabase) return;
        try {
            const { data: incomingData, error: incomingError } = await supabase
                .from('incoming_items')
                .select('*')
                .order('date', { ascending: false });

            if (incomingError) throw incomingError;
            incomingItems = incomingData || [];

            const { data: outgoingData, error: outgoingError } = await supabase
                .from('outgoing_items')
                .select('*')
                .order('date', { ascending: false });

            if (outgoingError) throw outgoingError;
            outgoingItems = outgoingData || [];

            recalculateAllData();
            updateAllDisplays();

        } catch (error) {
            console.error('Error fetching data:', error.message);
            showMessage('‚ùå Gagal mengambil data dari Supabase: ' + error.message, 'error');
        }
    }
    
    /**
     * Menghitung ulang Aggregated Stock & Borrowed Items menggunakan logika FIFO/Batch
     */
    function recalculateAllData() {
        aggregatedStock = {};
        borrowedItems = [];
        
        // Step 1: Initialize All Batches (Incoming Items) with mutable stock
        const allBatchesMap = {}; 

        incomingItems.forEach(item => {
            const key = `${item.name}|${item.category}`;

            const batchCopy = { 
                ...item, 
                quantity: parseInt(item.quantity, 10), 
                originalQuantity: parseInt(item.quantity, 10), 
            };
            allBatchesMap[item.id] = batchCopy;

            if (!aggregatedStock[key]) {
                aggregatedStock[key] = {
                    name: item.name,
                    category: item.category,
                    totalQuantity: 0,
                    room: item.room,
                    rackCode: item.rackCode,
                    description: item.description,
                    condition: item.condition,
                    incomingDetails: []
                };
            }
            aggregatedStock[key].incomingDetails.push(batchCopy);
        });
        
        // Step 2: Subtract Outgoing Items from specific batches and track borrowed items
        let totalIncoming = 0;
        let totalOutgoing = 0;

        outgoingItems.forEach(item => {
            const outgoingQuantity = parseInt(item.quantity, 10);
            
            if (!item.returned) {
                totalOutgoing += outgoingQuantity;

                if (item.incoming_batch_id && allBatchesMap[item.incoming_batch_id]) {
                    const batch = allBatchesMap[item.incoming_batch_id];
                    batch.quantity -= outgoingQuantity;
                } 
                
                // Tambahkan ke daftar pinjaman hanya jika kategorinya Aset dan belum dikembalikan
                if (item.category === 'Aset') {
                    borrowedItems.push(item);
                }
            }
        });

        // Step 3: Recalculate Total Stock and filter out empty batches
        Object.keys(aggregatedStock).forEach(key => {
            let totalStock = 0;
            let validBatches = [];
            
            // Hitung total quantity yang tersisa dari semua batch yang sudah dikurangi
            aggregatedStock[key].incomingDetails.forEach(batch => {
                totalIncoming += batch.originalQuantity; // Hitung total masuk dari kuantitas awal
                if (batch.quantity > 0) {
                    totalStock += batch.quantity;
                    validBatches.push(batch);
                }
            });
            
            aggregatedStock[key].totalQuantity = totalStock;
            // Simpan hanya batch yang tersisa, diurutkan dari terbaru (untuk tampilan di Stok Terkini)
            aggregatedStock[key].incomingDetails = validBatches.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (totalStock <= 0) {
                delete aggregatedStock[key];
            }
        });

        // Update Ringkasan Stok Total
        document.getElementById('totalIncoming').textContent = totalIncoming;
        document.getElementById('totalOutgoing').textContent = totalOutgoing;
        document.getElementById('remainingStock').textContent = Object.values(aggregatedStock).reduce((sum, item) => sum + item.totalQuantity, 0);

        console.log("Aggregated Stock (Final):", aggregatedStock);
    }
    
    async function addIncomingItemDB(item) {
        if (!supabase) throw new Error("Supabase is not initialized.");
        
        const newItem = {
            name: item.name.trim(), 
            category: item.category,
            quantity: parseInt(item.quantity, 10), 
            room: item.room,
            rackCode: item.rackCode,
            description: item.description,
            condition: item.condition,
            date: item.date, 
        };

        const { error } = await supabase
            .from('incoming_items')
            .insert([newItem]);
        
        if (error) {
            throw new Error('Gagal menyimpan barang masuk: ' + error.message);
        }
    }

    async function addOutgoingItemDB(item) {
        if (!supabase) throw new Error("Supabase is not initialized.");
        
        const newOutgoing = {
            name: item.name,
            category: item.category,
            quantity: parseInt(item.quantity, 10),
            user: item.user,
            date: item.date,
            incoming_batch_id: item.incoming_batch_id, 
            returned: false 
        };

        const { error } = await supabase
            .from('outgoing_items')
            .insert([newOutgoing]);
        
        if (error) {
            throw new Error('Gagal mencatat barang keluar: ' + error.message);
        }
    }

    async function markItemAsReturned(outgoingItemId) {
        if (!supabase) throw new Error("Supabase is not initialized.");

        const { error } = await supabase
            .from('outgoing_items')
            .update({ returned: true, return_date: new Date().toISOString().split('T')[0] })
            .eq('id', outgoingItemId);

        if (error) {
            throw new Error('Gagal mencatat pengembalian barang: ' + error.message);
        }
    }


    // ===========================================
    // FUNGSI LOGIKA FORM & TAMPILAN
    // ===========================================

    function showMessage(text, type = 'info') {
        const container = document.getElementById('messageContainer');
        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        const element = document.createElement('div');
        element.className = `fade-in ${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg mb-3 flex items-center space-x-2`;
        element.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
                ${type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
                ${type === 'info' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : ''}
            </svg>
            <span>${text}</span>
        `;
        container.prepend(element);

        setTimeout(() => {
            element.classList.remove('fade-in');
            element.classList.add('slide-up', 'opacity-0');
            element.addEventListener('animationend', () => element.remove());
        }, 5000);
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('is-open');
        document.getElementById(modalId).classList.remove('opacity-0', 'pointer-events-none');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('is-open');
        document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');
    }
    
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-md');
            button.classList.add('text-gray-600', 'hover:bg-gray-100');
        });

        const selectedContent = document.getElementById(tabName + 'Content');
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }
        
        const selectedTab = document.getElementById(tabName + 'Tab');
        if (selectedTab) {
            selectedTab.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-md');
            selectedTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
        }

        // Refresh data untuk tab tertentu
        if (tabName === 'outgoing') {
            populateOutgoingForm();
        } else if (tabName === 'return') {
            renderBorrowedItems();
        }
    }


    // --- 4. TAMPILAN STOK TERKINI ---

    function renderStockTable() {
        const body = document.getElementById('stockTableBody');
        body.innerHTML = '';
        
        const stockArray = Object.values(aggregatedStock).sort((a, b) => a.name.localeCompare(b.name));

        if (stockArray.length === 0) {
            body.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">Stok Gudang Kosong.</td></tr>';
            return;
        }

        stockArray.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-150 fade-in';
            
            const metadata = getItemMetadata(item.name, item.category);

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <button onclick="showStockDetail('${item.name}', '${item.category}')" class="text-blue-600 hover:text-blue-800 font-medium text-lg">${item.name}</button>
                    <p class="text-sm text-gray-500">${metadata?.room || 'N/A'} / ${metadata?.rackCode || 'N/A'}</p>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-xl font-bold ${item.totalQuantity < 10 ? 'text-red-500' : 'text-green-600'}">${item.totalQuantity}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="showTab('outgoing'); document.getElementById('outgoingItemSelect').value='${item.name}|${item.category}'; document.getElementById('outgoingItemSelect').dispatchEvent(new Event('change'))" class="text-indigo-600 hover:text-indigo-900">Ambil</button>
                </td>
            `;
            body.appendChild(row);
        });
    }

    window.showStockDetail = function(name, category) {
        const key = `${name}|${category}`;
        const item = aggregatedStock[key];
        const modalContent = document.getElementById('stockDetailContent');
        document.getElementById('stockDetailName').textContent = name;
        
        if (!item) {
            modalContent.innerHTML = '<p class="text-red-500">Data stok tidak ditemukan.</p>';
            openModal('stockDetailModal');
            return;
        }

        let html = `
            <div class="space-y-3">
                <p><strong>Kategori:</strong> ${item.category}</p>
                <p><strong>Stok Total:</strong> <span class="text-2xl font-bold text-blue-600">${item.totalQuantity}</span></p>
                <h4 class="font-semibold text-gray-800 mt-4 border-t pt-3">Detail Batch yang Tersisa (FIFO Order)</h4>
        `;

        // Sort by oldest date (FIFO - First In First Out)
        const sortedBatches = item.incomingDetails.sort((a, b) => new Date(a.date) - new Date(b.date));

        sortedBatches.forEach(batch => {
            html += `
                <div class="p-3 border rounded-lg bg-gray-50">
                    <p><strong>ID Batch:</strong> ${batch.id}</p>
                    <p><strong>Sisa Stok:</strong> <span class="font-bold text-lg text-teal-600">${batch.quantity}</span></p>
                    <p class="text-sm text-gray-600"><strong>Tanggal Masuk:</strong> ${batch.date}</p>
                    <p class="text-sm text-gray-600"><strong>Lokasi:</strong> ${batch.room} / ${batch.rackCode}</p>
                    <p class="text-xs text-gray-500">Deskripsi: ${batch.description}</p>
                </div>
            `;
        });
        
        modalContent.innerHTML = html + '</div>';
        openModal('stockDetailModal');
    }

    // --- 2. LOGIKA BARANG KELUAR (Outgoing) ---

    let selectedBatchData = null; // Menyimpan data batch yang sedang dipilih di form outgoing

    function populateOutgoingForm() {
        const select = document.getElementById('outgoingItemSelect');
        select.innerHTML = '<option value="">Pilih barang (Stok tersedia: 0)</option>';
        
        const stockArray = Object.values(aggregatedStock).sort((a, b) => a.name.localeCompare(b.name));

        stockArray.forEach(item => {
            if (item.totalQuantity > 0) {
                const key = `${item.name}|${item.category}`;
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${item.name} (${item.category}) - Stok: ${item.totalQuantity}`;
                select.appendChild(option);
            }
        });

        // Pastikan form batch tersembunyi saat pertama kali dimuat
        document.getElementById('batchSelectContainer').classList.add('hidden');
        document.getElementById('outgoingBatchSelect').innerHTML = '<option value="">Pilih batch spesifik</option>';
        document.getElementById('availableBatchStock').textContent = '0';
        document.getElementById('outgoingQuantity').value = '';
        selectedBatchData = null;
    }

    document.getElementById('outgoingItemSelect').addEventListener('change', function() {
        const key = this.value;
        const [name, category] = key.split('|');
        const batchSelect = document.getElementById('outgoingBatchSelect');
        const batchContainer = document.getElementById('batchSelectContainer');
        batchSelect.innerHTML = '<option value="">Pilih batch spesifik</option>';
        document.getElementById('batchDetailInfo').textContent = 'Pilih batch untuk melihat deskripsi lengkap.';
        document.getElementById('availableBatchStock').textContent = '0';
        document.getElementById('outgoingQuantity').value = '';
        selectedBatchData = null;

        if (key) {
            batchContainer.classList.remove('hidden');
            const batches = getAvailableBatches(name, category);
            
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = `ID Batch ${batch.id} | Stok: ${batch.quantity} | Masuk: ${batch.date}`;
                batchSelect.appendChild(option);
            });
            
            // Set default ke batch FIFO (pertama di list) jika ada
            if (batches.length > 0) {
                batchSelect.value = batches[0].id;
                // Panggil event change secara manual untuk mengupdate info
                batchSelect.dispatchEvent(new Event('change'));
            }

        } else {
            batchContainer.classList.add('hidden');
        }
    });

    document.getElementById('outgoingBatchSelect').addEventListener('change', function() {
        const batchId = parseInt(this.value);
        const key = document.getElementById('outgoingItemSelect').value;
        const [name, category] = key.split('|');

        if (batchId) {
            const batches = getAvailableBatches(name, category);
            const batch = batches.find(b => b.id === batchId);
            
            if (batch) {
                selectedBatchData = batch;
                document.getElementById('availableBatchStock').textContent = batch.quantity;
                document.getElementById('batchDetailInfo').innerHTML = 
                    `Tanggal: **${batch.date}** | Lokasi: **${batch.room} / ${batch.rackCode}** | Kondisi: **${batch.condition}** | Deskripsi: ${batch.description.substring(0, 50)}...`;
                document.getElementById('outgoingQuantity').max = batch.quantity;
            }
        } else {
            document.getElementById('availableBatchStock').textContent = '0';
            document.getElementById('batchDetailInfo').textContent = 'Pilih batch untuk melihat deskripsi lengkap.';
            selectedBatchData = null;
        }
    });


    document.getElementById('outgoingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const selectedKey = document.getElementById('outgoingItemSelect').value;
        const [name, category] = selectedKey.split('|');
        const quantity = parseInt(document.getElementById('outgoingQuantity').value, 10);
        const batchId = parseInt(document.getElementById('outgoingBatchSelect').value);
        
        if (!selectedBatchData || selectedBatchData.quantity < quantity) {
            showMessage('‚ö†Ô∏è Jumlah keluar melebihi stok yang tersedia di batch ini.', 'error');
            return;
        }

        const outgoingItem = {
            name: name,
            category: category,
            quantity: quantity,
            user: document.getElementById('outgoingUser').value,
            date: document.getElementById('outgoingDate').value,
            incoming_batch_id: batchId,
        };

        // Konfirmasi sebelum submit
        document.getElementById('outgoingConfirmationContent').innerHTML = `
            <p>Anda akan mengeluarkan:</p>
            <ul class="list-disc list-inside ml-4">
                <li><strong>Barang:</strong> ${outgoingItem.name}</li>
                <li><strong>Jumlah:</strong> <span class="text-red-600 font-bold">${outgoingItem.quantity}</span></li>
                <li><strong>Pengambil:</strong> ${outgoingItem.user}</li>
                <li><strong>Dari Batch ID:</strong> ${outgoingItem.incoming_batch_id}</li>
                <li><strong>Kategori:</strong> ${outgoingItem.category}</li>
            </ul>
        `;
        openModal('outgoingConfirmationModal');

        document.getElementById('confirmOutgoingBtn').onclick = async () => {
            closeModal('outgoingConfirmationModal');
            try {
                await addOutgoingItemDB(outgoingItem);
                showMessage(`‚úÖ ${outgoingItem.quantity} unit ${outgoingItem.name} telah dicatat sebagai keluar!`, 'success');
                
                // Refresh data dan form
                this.reset();
                await fetchData();
                populateOutgoingForm(); 
            } catch (error) {
                showMessage('‚ùå Gagal mencatat barang keluar: ' + error.message, 'error');
            }
        };
    });


    // --- 1. LOGIKA BARANG MASUK (Incoming) ---

    document.getElementById('incomingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const incomingItem = {
            name: document.getElementById('incomingItemName').value,
            category: document.getElementById('incomingCategory').value,
            quantity: document.getElementById('incomingQuantity').value,
            condition: document.getElementById('incomingCondition').value,
            room: document.getElementById('incomingRoom').value,
            rackCode: document.getElementById('incomingRackCode').value,
            description: document.getElementById('incomingDescription').value,
            date: document.getElementById('incomingDate').value,
        };

        try {
            await addIncomingItemDB(incomingItem);
            showMessage(`‚úÖ ${incomingItem.quantity} unit ${incomingItem.name} (${incomingItem.category}) berhasil dicatat!`, 'success');
            
            // Reset form dan refresh data
            this.reset();
            document.getElementById('incomingDate').value = new Date().toISOString().split('T')[0];
            await fetchData();

        } catch (error) {
            showMessage('‚ùå Gagal menyimpan barang masuk: ' + error.message, 'error');
        }
    });

    // --- 3. LOGIKA PENGEMBALIAN BARANG (Return) ---
    
    function renderBorrowedItems() {
        const listContainer = document.getElementById('borrowedItemsList');
        listContainer.innerHTML = '';

        if (borrowedItems.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada Aset yang sedang dipinjam saat ini.</p>';
            return;
        }

        // Kelompokkan berdasarkan Nama Barang & Kategori
        const groupedItems = borrowedItems.reduce((acc, item) => {
            const key = `${item.name}|${item.user}`;
            if (!acc[key]) {
                acc[key] = { name: item.name, user: item.user, items: [] };
            }
            acc[key].items.push(item);
            return acc;
        }, {});

        Object.values(groupedItems).forEach(group => {
            const totalBorrowed = group.items.reduce((sum, item) => sum + parseInt(item.quantity, 10), 0);
            
            const card = document.createElement('div');
            card.className = 'p-4 border border-blue-200 bg-blue-50 rounded-xl shadow-sm hover:shadow-md transition duration-200';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-lg font-bold text-gray-800">${group.name} (<span class="text-blue-600">${group.user}</span>)</p>
                        <p class="text-sm text-gray-600 mt-1">Total Jumlah Dipinjam: <span class="font-semibold">${totalBorrowed}</span> unit</p>
                    </div>
                    <button onclick="returnItem('${group.items[0].id}', '${group.name}', '${group.user}')" class="bg-indigo-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-indigo-600 text-sm">
                        Proses Pengembalian
                    </button>
                </div>
            `;
            listContainer.appendChild(card);
        });
    }

    window.returnItem = async function(firstItemId, name, user) {
        // Ambil semua item dari pengguna/barang yang sama
        const itemsToReturn = borrowedItems.filter(item => item.name === name && item.user === user);
        
        let detailHtml = `
            <p class="text-gray-700">Detail peminjaman oleh **${user}**:</p>
            <ul class="list-disc list-inside ml-4 space-y-2">
        `;
        
        itemsToReturn.forEach(item => {
            detailHtml += `
                <li class="p-2 border-b">
                    <span class="font-semibold">${item.quantity} unit</span> - Tanggal Keluar: ${item.date} <br>
                    <span class="text-xs text-gray-500">ID Outgoing: ${item.id} | Batch ID: ${item.incoming_batch_id || 'N/A'}</span>
                    <button onclick="confirmReturnSingle(${item.id}, '${item.name}', ${item.quantity})" class="ml-3 text-red-500 hover:text-red-700 text-xs font-medium">Selesaikan Pengembalian</button>
                </li>
            `;
        });

        detailHtml += `</ul>`;
        
        document.getElementById('returnDetailContent').innerHTML = detailHtml;
        openModal('returnDetailModal');
    }

    window.confirmReturnSingle = async function(outgoingId, name, quantity) {
        if (!confirm(`Konfirmasi pengembalian ${quantity} unit ${name}?`)) {
            return;
        }

        try {
            await markItemAsReturned(outgoingId);
            showMessage(`‚úÖ ${quantity} unit ${name} (ID: ${outgoingId}) berhasil dicatat dikembalikan.`, 'success');
            
            // Refresh data dan tampilan
            closeModal('returnDetailModal');
            await fetchData();
            renderBorrowedItems(); 
            
        } catch (error) {
            showMessage('‚ùå Gagal memproses pengembalian: ' + error.message, 'error');
        }
    }


    // --- FUNGSI EXPORT (Tidak diubah) ---
    
    window.exportToExcel = function() {
        const dataForExport = [];

        // Gabungkan Incoming dan Outgoing, lalu tambahkan Stok Terkini
        
        // 1. Data Incoming
        incomingItems.forEach(item => {
            dataForExport.push({
                Tipe: 'MASUK',
                'ID Transaksi': item.id,
                'Nama Barang': item.name,
                Kategori: item.category,
                Jumlah: item.quantity,
                'Tgl Transaksi': item.date,
                Ruang: item.room,
                'Kode Rak': item.rackCode,
                Kondisi: item.condition,
                Deskripsi: item.description,
                Pengguna: 'N/A',
                Status: 'Selesai',
                'ID Batch Masuk': item.id,
            });
        });

        // 2. Data Outgoing
        outgoingItems.forEach(item => {
            dataForExport.push({
                Tipe: 'KELUAR',
                'ID Transaksi': item.id,
                'Nama Barang': item.name,
                Kategori: item.category,
                Jumlah: -item.quantity, // Nilai negatif untuk keluar
                'Tgl Transaksi': item.date,
                Ruang: 'N/A',
                'Kode Rak': 'N/A',
                Kondisi: 'N/A',
                Deskripsi: 'N/A',
                Pengguna: item.user,
                Status: item.returned ? `Dikembalikan (${item.return_date})` : 'Belum Dikembalikan',
                'ID Batch Masuk': item.incoming_batch_id,
            });
        });

        // 3. Data Stok Terkini (Ringkasan)
        Object.values(aggregatedStock).forEach(item => {
            const metadata = getItemMetadata(item.name, item.category);
            dataForExport.push({
                Tipe: 'STOK_TERKINI',
                'ID Transaksi': 'N/A',
                'Nama Barang': item.name,
                Kategori: item.category,
                Jumlah: item.totalQuantity,
                'Tgl Transaksi': new Date().toISOString().split('T')[0],
                Ruang: metadata?.room || 'N/A',
                'Kode Rak': metadata?.rackCode || 'N/A',
                Kondisi: metadata?.condition || 'N/A',
                Deskripsi: metadata?.description || 'N/A',
                Pengguna: 'Gudang',
                Status: 'Aktif',
                'ID Batch Masuk': 'N/A',
            });
        });
        
        const worksheet = XLSX.utils.json_to_sheet(dataForExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data_Inventori_GudangCeria");
        
        XLSX.writeFile(workbook, "GudangCeria_Export_" + new Date().toISOString().split('T')[0] + ".xlsx");
        showMessage('Export data ke Excel berhasil!', 'success');
    }
    
    /**
     * Memperbarui semua elemen tampilan setelah data dihitung ulang
     */
    function updateAllDisplays() {
        renderStockTable();
        populateOutgoingForm();
        renderBorrowedItems(); // Dipanggil di showTab('return'), tapi dipanggil di sini juga untuk inisialisasi
    }


    // ===========================================
    // INISIALISASI
    // ===========================================

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('incomingDate').value = today;
        document.getElementById('outgoingDate').value = today;
        
        fetchData(); 
        showTab('stock'); // Tampilkan tab 'stock' saat pertama kali dimuat
    });

</script>
</body>
</html>
